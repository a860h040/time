<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Model Fix Calculator — Dates + Adjustable Table</title>
<style>
  :root{
    --bg:#0b0b0c; --card:#121214; --grid:#222; --text:#eaeaea; --muted:#a8a8a8; --accent:#4ea3ff;
    --fs:14px;         /* font size */
    --rowpad:10px;     /* vertical padding in cells */
    --w-date:180px;    /* column widths */
    --w-col:200px;
    --zoom:1;          /* overall zoom */
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Arial,sans-serif;font-size:var(--fs)}
  header{padding:12px 16px;border-bottom:1px solid var(--grid);background:#101013;position:sticky;top:0;z-index:2}
  h1{margin:0;font-size:18px}
  .sub{color:var(--muted);font-size:12px;margin-top:4px}
  .wrap{padding:16px}
  .panel{
    display:flex;flex-wrap:wrap;gap:8px;align-items:end;margin-bottom:12px;padding:10px;border:1px solid var(--grid);
    border-radius:10px;background:var(--card)
  }
  .field{display:flex;flex-direction:column;gap:4px}
  .field label{font-size:12px;color:var(--muted)}
  .field input[type="number"], .field input[type="range"]{
    background:#151518;border:1px solid #2a2a2a;color:var(--text);padding:6px 8px;border-radius:8px;min-width:80px
  }
  .panel button{
    background:#1a1a1a;border:1px solid #2b2b2b;color:#ddd;padding:8px 12px;border-radius:8px;cursor:pointer
  }
  .panel button:hover{border-color:var(--accent)}
  .sheet-outer{transform:scale(var(--zoom));transform-origin:top left}
  .sheet{width:100%;overflow:auto;border:1px solid var(--grid);border-radius:10px;background:var(--card)}
  table{border-collapse:collapse;width:100%;min-width:920px}
  thead th{
    position:sticky;top:0;background:#17171a;border-bottom:1px solid var(--grid);
    padding:10px;text-align:left;font-weight:600
  }
  th.date{width:var(--w-date)}
  th.col{width:var(--w-col)}
  tbody td{border-top:1px solid var(--grid);padding:0}
  input.cell, input[type="date"]{
    width:100%;padding:var(--rowpad) 12px;background:transparent;border:none;outline:none;color:var(--text);font:inherit;text-align:right
  }
  input[type="date"]{text-align:left}
  .ro{background:rgba(255,255,255,0.04);color:#dcdcdc}
  .hint{color:var(--muted);font-size:12px;margin-top:6px}
</style>
</head>
<body>
<header>
  <h1>Model Fix Calculator</h1>
  <div class="sub">First column is <strong>Date</strong>. Change any date → rows below auto-increment by 1 day. Enter <strong>A</strong> and <strong>B</strong>; <strong>C</strong>, <strong>D</strong>, <strong>E</strong> calculate automatically.</div>
</header>

<div class="wrap">
  <!-- Adjustable parameters -->
  <div class="panel" id="panel">
    <div class="field"><label for="rows">Rows</label><input id="rows" type="number" value="7" min="1" step="1"></div>
    <div class="field"><label for="fs">Font (px)</label><input id="fs" type="number" value="14" min="10" max="24" step="1"></div>
    <div class="field"><label for="rh">Row padding (px)</label><input id="rh" type="number" value="10" min="4" max="24" step="1"></div>
    <div class="field"><label for="wdate">Date width (px)</label><input id="wdate" type="number" value="180" min="100" max="400" step="10"></div>
    <div class="field"><label for="wcol">Other cols width (px)</label><input id="wcol" type="number" value="200" min="120" max="500" step="10"></div>
    <div class="field" style="min-width:180px"><label for="zoom">Zoom</label><input id="zoom" type="range" value="1" min="0.7" max="1.5" step="0.01"></div>
    <button id="apply">Apply</button>
    <button id="setToday">Set first date = today</button>
    <button id="clearAB">Clear A/B/C/D/E</button>
  </div>

  <div class="sheet-outer">
    <div class="sheet">
      <table id="grid" aria-label="Model Fix Grid">
        <thead>
          <tr>
            <th class="date">Date</th>
            <th class="col">Model 1 (A)</th>
            <th class="col">Model 2 (B)</th>
            <th class="col">Fix1 (C)</th>
            <th class="col">Fix2 (D)</th>
            <th class="col">Fix3 (E)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="hint">
    C = 0.543·A + 0.457·B &nbsp;|&nbsp;
    D = 12542.898914·A + 11420.962628·B − 109.512226·A² − 113.529363·B² − 673.234821·A·B − 2.044843·A³ − 0.046012·B³ + 8.490782·A²·B + 4.692059·A·B² − 212212.65665 &nbsp;|&nbsp;
    E = 0.964·A + 0.036·B − 0.695
  </div>
</div>

<script>
(function(){
  const tbody = document.getElementById('tbody');

  // Panel refs
  const rowsInput = document.getElementById('rows');
  const fsInput   = document.getElementById('fs');
  const rhInput   = document.getElementById('rh');
  const wdateInput= document.getElementById('wdate');
  const wcolInput = document.getElementById('wcol');
  const zoomInput = document.getElementById('zoom');
  const applyBtn  = document.getElementById('apply');
  const setToday  = document.getElementById('setToday');
  const clearAB   = document.getElementById('clearAB');

  // Helpers
  const dayMs = 24*60*60*1000;
  const toISODate = d => new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  const parseDate = s => { const d = new Date(s); return isNaN(d)?null:d; };
  const fmt = n => (isFinite(n) ? n.toFixed(6).replace(/\.?0+$/,'') : "");

  function compute(A,B){
    const C = 0.543*A + 0.457*B;
    const D = 12542.898914*A + 11420.962628*B
            - 109.512226*A*A - 113.529363*B*B
            - 673.234821*A*B
            - 2.044843*A*A*A - 0.046012*B*B*B
            + 8.490782*A*A*B + 4.692059*A*B*B
            - 212212.65665;
    const E = 0.964*A + 0.036*B - 0.695;
    return {C,D,E};
  }

  function rowEl(){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="cell date" type="date" aria-label="Date"></td>
      <td><input class="cell a" type="number" step="any" placeholder="A" inputmode="decimal" aria-label="A"></td>
      <td><input class="cell b" type="number" step="any" placeholder="B" inputmode="decimal" aria-label="B"></td>
      <td><input class="cell ro c" type="text" placeholder="C" aria-label="C" readonly></td>
      <td><input class="cell ro d" type="text" placeholder="D" aria-label="D" readonly></td>
      <td><input class="cell ro e" type="text" placeholder="E" aria-label="E" readonly></td>
    `;
    return tr;
  }

  function setCSSVars(){
    document.documentElement.style.setProperty('--fs', fsInput.value+'px');
    document.documentElement.style.setProperty('--rowpad', rhInput.value+'px');
    document.documentElement.style.setProperty('--w-date', wdateInput.value+'px');
    document.documentElement.style.setProperty('--w-col', wcolInput.value+'px');
    document.documentElement.style.setProperty('--zoom', zoomInput.value);
  }

  function ensureRows(n){
    n = Math.max(1, Math.floor(n));
    rowsInput.value = n;
    const cur = tbody.rows.length;
    if (n > cur){
      for (let i=0;i<n-cur;i++) tbody.appendChild(rowEl());
      // continue dates from last known
      cascadeDatesFrom(Math.max(0, cur-1), true);
    } else if (n < cur){
      for (let i=0;i<cur-n;i++) tbody.removeChild(tbody.lastElementChild);
    }
  }

  function recomputeRow(tr){
    const A = parseFloat(tr.querySelector('.a').value);
    const B = parseFloat(tr.querySelector('.b').value);
    const cEl = tr.querySelector('.c');
    const dEl = tr.querySelector('.d');
    const eEl = tr.querySelector('.e');
    if (isNaN(A) || isNaN(B)){
      cEl.value = dEl.value = eEl.value = "";
      return;
    }
    const {C,D,E} = compute(A,B);
    cEl.value = fmt(C);
    dEl.value = fmt(D);
    eEl.value = fmt(E);
  }

  function recomputeAll(){ [...tbody.rows].forEach(recomputeRow); }

  // Cascade dates: from index i downward; if onlyFillBlanks = true, don't overwrite existing dates
  function cascadeDatesFrom(i, onlyFillBlanks=false){
    const rows = [...tbody.rows];
    if (!rows.length) return;
    i = Math.max(0, Math.min(i, rows.length-1));

    // Establish base date at i (use given, or infer from neighbors, or today)
    let baseStr = rows[i].querySelector('.date').value;
    let base = parseDate(baseStr);
    if (!base){
      // try above
      for (let k=i-1;k>=0;k--){
        const d = parseDate(rows[k].querySelector('.date').value);
        if (d){ base = new Date(d.getTime() + (i-k)*dayMs); break; }
      }
      // try below
      if (!base){
        for (let k=i+1;k<rows.length;k++){
          const d = parseDate(rows[k].querySelector('.date').value);
          if (d){ base = new Date(d.getTime() - (k-i)*dayMs); break; }
        }
      }
      if (!base) base = new Date();
      rows[i].querySelector('.date').value = toISODate(base);
    }

    // Fill downward
    for (let r=i+1;r<rows.length;r++){
      const prevDate = parseDate(rows[r-1].querySelector('.date').value);
      if (!prevDate) break;
      const tgt = rows[r].querySelector('.date');
      if (!onlyFillBlanks || !tgt.value){
        tgt.value = toISODate(new Date(prevDate.getTime()+dayMs));
      }
    }
  }

  // Events
  tbody.addEventListener('input', (e)=>{
    const t = e.target;
    if (!(t instanceof HTMLInputElement)) return;
    if (t.classList.contains('a') || t.classList.contains('b')){
      recomputeRow(t.closest('tr'));
    }
  });
  tbody.addEventListener('change', (e)=>{
    const t = e.target;
    if (!(t instanceof HTMLInputElement)) return;
    if (t.classList.contains('date')){
      const tr = t.closest('tr');
      const idx = [...tbody.rows].indexOf(tr);
      const d = parseDate(t.value);
      if (!d){ t.value=""; return; }
      t.value = toISODate(d);           // normalize
      cascadeDatesFrom(idx, false);     // push downstream
    }
  });

  applyBtn.onclick = ()=>{
    setCSSVars();
    ensureRows(parseInt(rowsInput.value||'1',10));
  };
  setToday.onclick = ()=>{
    if (!tbody.rows.length) ensureRows(1);
    const first = tbody.rows[0].querySelector('.date');
    first.value = toISODate(new Date());
    cascadeDatesFrom(0,false);
  };
  clearAB.onclick = ()=>{
    [...tbody.querySelectorAll('.a,.b,.c,.d,.e')].forEach(el=> el.value="");
  };

  // Init
  setCSSVars();
  ensureRows(parseInt(rowsInput.value,10));
  // Start with first date = today and cascade
  if (tbody.rows.length){
    tbody.rows[0].querySelector('.date').value = toISODate(new Date());
    cascadeDatesFrom(0,false);
  }
})();
</script>
</body>
</html>
